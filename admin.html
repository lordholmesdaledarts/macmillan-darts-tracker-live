<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Macmillan Darts â€“ Admin</title>
  <link rel="stylesheet" href="./styles.css" />
</head>

<body class="admin">
  <div class="wrap">

    <header class="title">
      <h1>Macmillan Darts</h1>
      <p class="sub">Admin control</p>
    </header>

    <!-- ================= TOP ROW ================= -->
    <div class="admin-top">

      <!-- Score entry -->
      <section class="card">
        <div class="label">Score entry</div>

        <div class="entry-wide">
          <input
            id="manual"
            type="number"
            inputmode="numeric"
            placeholder="Score"
          />
          <button class="primary" id="addManual">Add</button>
          <button class="warn" id="undoBtn">Undo</button>
        </div>

        <div class="quick-row">
          <button class="chip" data-add="60">+60</button>
          <button class="chip" data-add="100">+100</button>
          <button class="chip" data-add="140">+140</button>
          <button class="chip" data-add="180">+180</button>
          <button class="chip" data-add="301">+301</button>
          <button class="chip" data-add="501">+501</button>
          <button class="chip" data-add="1000">+1000</button>
          <button class="chip" data-add="969">+969</button>
          <button class="chip" data-add="961">+961</button>
          <button class="chip" data-add="981">+981</button>
        </div>

        <p class="subtle" style="margin-top:0.9rem">
          Tip: type a number â†’ Add. Undo reverses the last added amount.
        </p>
      </section>

      <!-- Total points -->
      <section class="card">
        <div class="label">Total points</div>
        <div class="hero-value mono" id="total">0</div>
        <p class="subtle" style="margin-top:0.75rem">
          Live value used on the display screen.
        </p>
      </section>

    </div>

    <!-- ================= EVENT SETUP ================= -->
    <details class="admin-settings" open>
      <summary>Event setup</summary>

      <div class="settings-grid">

        <!-- Targets -->
        <section class="card">
          <div class="label">Event targets (hard reset)</div>

          <div
            style="
              display:grid;
              grid-template-columns:1fr 1fr;
              gap:0.75rem;
              margin-top:0.5rem
            "
          >
            <input
              id="targetInput"
              type="number"
              placeholder="Target points"
            />
            <input
              id="hoursInput"
              type="number"
              placeholder="Hours"
            />
          </div>

          <button
            class="primary full"
            id="saveTargets"
            style="margin-top:0.9rem"
          >
            Save targets & start new event
          </button>

          <p class="subtle" style="margin-top:0.6rem">
            This resets score and timer.
          </p>
        </section>

        <!-- Timer -->
        <section class="card">
          <div class="label">Timer</div>

          <div style="display:flex; gap:0.75rem; margin-top:0.75rem">
            <button class="primary" id="startTimer">Start</button>
            <button class="warn" id="resetTimer">Reset</button>
          </div>

          <p class="subtle" id="timerStatus" style="margin-top:0.75rem">
            Timer not started
          </p>
        </section>

      </div>
    </details>

  </div>

<script type="module">
import { supabase, EVENT_ID } from "./supabase.js";

console.log("ðŸŸ¢ Admin loaded for event:", EVENT_ID);

let state = null;

/* ---------- Load ---------- */
async function load() {
  const { data, error } = await supabase
    .from("events")
    .select("*")
    .eq("id", EVENT_ID)
    .single();

  if (error) {
    alert("Failed to load event: " + error.message);
    return;
  }

  state = data;
  syncUI();
}

/* ---------- Sync UI ---------- */
function syncUI() {
  if (!state) return;

  total.textContent = Number(state.total || 0).toLocaleString();
  targetInput.value = state.target ?? "";
  hoursInput.value = state.duration_hours ?? "";

  updateTimerStatus();
}

/* ---------- DB update ---------- */
async function updateEvent(patch) {
  console.log("â¬†ï¸ Updating event:", patch);

  const { data, error } = await supabase
    .from("events")
    .update(patch)
    .eq("id", EVENT_ID)
    .select();

  if (error) {
    console.error("âŒ Update failed:", error);
    alert(error.message);
    return;
  }

  console.log("âœ… Update success:", data);
}

/* ---------- Scoring ---------- */
async function add(delta) {
  if (!state) return;

  await updateEvent({
    total: (state.total || 0) + delta,
    last_delta: delta
  });
}

async function undo() {
  if (!state?.last_delta) return alert("Nothing to undo.");

  await updateEvent({
    total: Math.max(0, state.total - state.last_delta),
    last_delta: 0
  });
}

/* ---------- HARD RESET: Save targets ---------- */
async function saveTargetsHandler() {
  const target = Number(targetInput.value || 0);
  const hours = Number(hoursInput.value || 0);

  if (!target || !hours) {
    alert("Please enter both target points and hours.");
    return;
  }

  if (
    !confirm(
      "Start a new event?\n\nThis will reset:\nâ€¢ Total points\nâ€¢ Timer\nâ€¢ Progress"
    )
  ) {
    return;
  }

  console.log("ðŸŽ¯ Starting fresh event", { target, hours });

  await updateEvent({
    target,
    duration_hours: hours,
    duration_minutes: hours * 60,
    total: 0,
    last_delta: 0,
    started_at: null
  });
}

/* ---------- Timer ---------- */
async function startTimerHandler() {
  console.log("â± Start timer clicked");

  await updateEvent({
    started_at: new Date().toISOString()
  });
}

async function resetTimerHandler() {
  if (!confirm("Reset the timer back to full duration?")) return;

  await updateEvent({
    started_at: null
  });
}

function updateTimerStatus() {
  if (!state?.started_at) {
    timerStatus.textContent = "Timer not started";
    timerStatus.style.color = "";
    startTimer.textContent = "Start";
    return;
  }

  timerStatus.textContent = "â± Timer running";
  timerStatus.style.color = "#39d98a";
  startTimer.textContent = "Runningâ€¦";
}

/* ---------- Wiring ---------- */
document.querySelectorAll("[data-add]").forEach(btn =>
  btn.addEventListener("click", () =>
    add(Number(btn.dataset.add))
  )
);

addManual.addEventListener("click", () => {
  const v = Number(manual.value || 0);
  if (v) add(v);
});

undoBtn.addEventListener("click", undo);
saveTargets.addEventListener("click", saveTargetsHandler);
startTimer.addEventListener("click", startTimerHandler);
resetTimer.addEventListener("click", resetTimerHandler);

/* ---------- Realtime sync ---------- */
supabase
  .channel("events-admin")
  .on(
    "postgres_changes",
    { event: "UPDATE", schema: "public", table: "events" },
    payload => {
      state = payload.new;
      syncUI();
    }
  )
  .subscribe();

load();
</script>

</body>
</html>
