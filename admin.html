<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Control – Charity Event</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>

<div class="wrap">
  <header class="title">
    <h1>Admin Control</h1>
    <p class="sub">Live score & timing · Charity event</p>
  </header>

  <div class="grid">

    <!-- Total -->
    <section class="card">
      <div class="label">Total points</div>
      <div class="value hero mono" id="total">0</div>
    </section>

    <!-- Event settings -->
    <section class="card">
      <div class="label">Event settings</div>

      <div class="row">
        <input id="targetInput" type="number" inputmode="numeric" placeholder="Target points" />
        <input id="durationInput" type="number" inputmode="numeric" placeholder="Hours" />
      </div>

      <button class="primary full" id="saveSettings">Save settings</button>
    </section>

    <!-- Timer -->
    <section class="card">
      <div class="label">Timer</div>
      <div class="row">
        <button class="chip" id="startBtn">Start</button>
        <button class="chip" id="pauseBtn">Pause</button>
        <button class="chip" id="resetBtn">Reset</button>
      </div>
    </section>

    <!-- Quick add -->
    <section class="card">
      <div class="label">Quick add</div>
      <div class="quick">
        <button class="chip" data-add="26">+26</button>
        <button class="chip" data-add="60">+60</button>
        <button class="chip" data-add="100">+100</button>
        <button class="chip" data-add="140">+140</button>
        <button class="chip" data-add="180">+180</button>
        <button class="chip" data-add="301">+301</button>
        <button class="chip" data-add="501">+501</button>
      </div>
    </section>

    <!-- Manual -->
    <section class="card">
      <div class="label">Manual entry</div>
      <div class="row">
        <input id="manual" type="number" inputmode="numeric" placeholder="Score" />
        <button class="primary" id="addManual">Add</button>
      </div>
    </section>

    <!-- Undo -->
    <section class="card warn-card">
      <div class="label">Correction</div>
      <button class="warn full" id="undoBtn">Undo last entry</button>
    </section>

  </div>

  <p class="footer-note">Admin only · Everything syncs live</p>
</div>

<script type="module">
import { supabase, EVENT_ID } from "./supabase.js";

const totalEl = document.getElementById("total");
const targetInput = document.getElementById("targetInput");
const durationInput = document.getElementById("durationInput");

async function load() {
  const { data } = await supabase
    .from("events")
    .select("*")
    .eq("id", EVENT_ID)
    .single();

  if (!data) return;

  totalEl.textContent = data.total.toLocaleString();
  targetInput.value = data.target;
  durationInput.value = Math.round(data.duration_minutes / 60);
}

async function add(delta) {
  const { data } = await supabase
    .from("events")
    .select("total")
    .eq("id", EVENT_ID)
    .single();

  await supabase
    .from("events")
    .update({
      total: Math.max(0, data.total + delta),
      last_delta: delta
    })
    .eq("id", EVENT_ID);
}

async function undo() {
  const { data } = await supabase
    .from("events")
    .select("total, last_delta")
    .eq("id", EVENT_ID)
    .single();

  if (!data.last_delta) return alert("Nothing to undo.");

  if (!confirm(`Undo last entry (${data.last_delta})?`)) return;

  await supabase
    .from("events")
    .update({
      total: Math.max(0, data.total - data.last_delta),
      last_delta: 0
    })
    .eq("id", EVENT_ID);
}

async function saveSettings() {
  const target = Number(targetInput.value);
  const hours = Number(durationInput.value);
  if (!target || !hours) return;

  await supabase
    .from("events")
    .update({
      target,
      duration_minutes: hours * 60
    })
    .eq("id", EVENT_ID);
}

async function startTimer() {
  await supabase.from("events").update({
    started_at: new Date().toISOString(),
    paused_at: null,
    is_running: true
  }).eq("id", EVENT_ID);
}

async function pauseTimer() {
  await supabase.from("events").update({
    paused_at: new Date().toISOString(),
    is_running: false
  }).eq("id", EVENT_ID);
}

async function resetTimer() {
  if (!confirm("Reset timer?")) return;
  await supabase.from("events").update({
    started_at: null,
    paused_at: null,
    is_running: false
  }).eq("id", EVENT_ID);
}

document.querySelectorAll("[data-add]").forEach(b =>
  b.onclick = () => add(Number(b.dataset.add))
);

document.getElementById("addManual").onclick = () => {
  const v = Number(manual.value);
  if (v) add(v);
  manual.value = "";
};

document.getElementById("undoBtn").onclick = undo;
document.getElementById("saveSettings").onclick = saveSettings;
document.getElementById("startBtn").onclick = startTimer;
document.getElementById("pauseBtn").onclick = pauseTimer;
document.getElementById("resetBtn").onclick = resetTimer;

supabase.channel("events")
  .on("postgres_changes", { event: "UPDATE", table: "events" }, load)
  .subscribe();

load();
</script>

</body>
</html>
