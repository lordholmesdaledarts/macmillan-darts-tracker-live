<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Control – Charity Event</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>

<div class="wrap">
  <header class="title">
    <h1>Admin Control</h1>
    <p class="sub">Live score & timing · Charity event</p>
  </header>

  <!-- SCORING (always visible) -->
  <div class="grid">

    <section class="card">
      <div class="label">Total points</div>
      <div class="value hero mono" id="total">0</div>
    </section>

    <section class="card">
      <div class="label">Quick add</div>
      <div class="quick">
        <button class="chip" data-add="26">+26</button>
        <button class="chip" data-add="60">+60</button>
        <button class="chip" data-add="100">+100</button>
        <button class="chip" data-add="140">+140</button>
        <button class="chip" data-add="180">+180</button>
        <button class="chip" data-add="301">+301</button>
        <button class="chip" data-add="501">+501</button>
      </div>
    </section>

    <section class="card">
      <div class="label">Manual entry</div>
      <div class="row">
        <input id="manual" type="number" inputmode="numeric" placeholder="Score" />
        <button class="primary" id="addManual">Add</button>
      </div>
    </section>

    <section class="card warn-card">
      <div class="label">Correction</div>
      <button class="warn full" id="undoBtn">Undo last entry</button>
    </section>

  </div>

  <!-- ADMIN SETTINGS (collapsible) -->
  <details class="admin-settings">
    <summary>Admin settings (tap to expand)</summary>

    <div class="grid">

      <section class="card">
        <div class="label">Event settings</div>
        <div class="row">
          <input id="targetInput" type="number" inputmode="numeric" placeholder="Target points" />
          <input id="durationInput" type="number" inputmode="numeric" placeholder="Hours" />
        </div>
        <button class="primary full" id="saveSettings">Save settings</button>
      </section>

      <section class="card">
        <div class="label">Timer</div>
        <div class="row">
          <button class="chip" id="startBtn">Start</button>
          <button class="chip" id="pauseBtn">Pause</button>
          <button class="chip" id="resetTimerBtn">Reset timer</button>
        </div>
      </section>

      <section class="card warn-card">
        <div class="label">Danger zone</div>
        <button class="warn full" id="resetPointsBtn">Reset points</button>
      </section>

    </div>
  </details>

  <p class="footer-note">Admin only · Changes sync instantly</p>
</div>

<script type="module">
import { supabase, EVENT_ID } from "./supabase.js";

const totalEl = document.getElementById("total");
const startBtn = document.getElementById("startBtn");
const pauseBtn = document.getElementById("pauseBtn");

let state = null;

async function load() {
  const { data } = await supabase.from("events").select("*").eq("id", EVENT_ID).single();
  state = data;
  totalEl.textContent = data.total.toLocaleString();
  targetInput.value = data.target;
  durationInput.value = Math.round(data.duration_minutes / 60);
  updateTimerButtons();
}

function updateTimerButtons() {
  startBtn.classList.toggle("active", state.is_running);
  pauseBtn.classList.toggle("active", !state.is_running && state.started_at);
}

async function add(delta) {
  await supabase.from("events").update({
    total: Math.max(0, state.total + delta),
    last_delta: delta
  }).eq("id", EVENT_ID);
}

async function undo() {
  if (!state.last_delta) return alert("Nothing to undo.");
  if (!confirm(`Undo last entry (${state.last_delta})?`)) return;
  await supabase.from("events").update({
    total: Math.max(0, state.total - state.last_delta),
    last_delta: 0
  }).eq("id", EVENT_ID);
}

async function saveSettings() {
  await supabase.from("events").update({
    target: Number(targetInput.value),
    duration_minutes: Number(durationInput.value) * 60
  }).eq("id", EVENT_ID);
}

async function startTimer() {
  await supabase.from("events").update({
    started_at: new Date().toISOString(),
    paused_at: null,
    is_running: true
  }).eq("id", EVENT_ID);
}

async function pauseTimer() {
  await supabase.from("events").update({
    paused_at: new Date().toISOString(),
    is_running: false
  }).eq("id", EVENT_ID);
}

async function resetTimer() {
  if (!confirm("Reset timer?")) return;
  await supabase.from("events").update({
    started_at: null,
    paused_at: null,
    is_running: false
  }).eq("id", EVENT_ID);
}

async function resetPoints() {
  if (!confirm("Reset ALL points to zero?")) return;
  await supabase.from("events").update({
    total: 0,
    last_delta: 0
  }).eq("id", EVENT_ID);
}

document.querySelectorAll("[data-add]").forEach(b => b.onclick = () => add(Number(b.dataset.add)));
addManual.onclick = () => manual.value && add(Number(manual.value));
undoBtn.onclick = undo;
saveSettings.onclick = saveSettings;
startBtn.onclick = startTimer;
pauseBtn.onclick = pauseTimer;
resetTimerBtn.onclick = resetTimer;
resetPointsBtn.onclick = resetPoints;

supabase.channel("events")
  .on("postgres_changes", { event: "UPDATE", table: "events" }, payload => {
    state = payload.new;
    totalEl.textContent = state.total.toLocaleString();
    updateTimerButtons();
  })
  .subscribe();

load();
</script>

</body>
</html>
