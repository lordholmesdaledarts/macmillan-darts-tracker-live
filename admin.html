<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Control – Macmillan Darts</title>
  <link rel="stylesheet" href="styles.css" />
</head>

<body>

<div class="wrap">
  <header class="title">
    <h1>Admin Control</h1>
    <p class="sub">Live score entry · Charity event</p>
  </header>

  <div class="grid">

    <!-- Total -->
    <section class="card">
      <div class="label">Total points</div>
      <div class="value hero mono" id="total">0</div>
    </section>

    <!-- Quick add -->
    <section class="card">
      <div class="label">Quick add</div>
      <div class="quick">
        <button class="chip" data-add="26">+26</button>
        <button class="chip" data-add="41">+41</button>
        <button class="chip" data-add="45">+45</button>
        <button class="chip" data-add="60">+60</button>
        <button class="chip" data-add="85">+85</button>
        <button class="chip" data-add="100">+100</button>
        <button class="chip" data-add="140">+140</button>
        <button class="chip" data-add="180">+180</button>
        <button class="chip" data-add="301">+301</button>
        <button class="chip" data-add="501">+501</button>
      </div>
    </section>

    <!-- Manual -->
    <section class="card">
      <div class="label">Manual entry</div>
      <div class="row">
        <input
          id="manual"
          type="number"
          inputmode="numeric"
          placeholder="Score (e.g. 500)"
        />
        <button class="primary" id="addManual">Add</button>
      </div>
    </section>

    <!-- Undo -->
    <section class="card warn-card">
      <div class="label">Correction</div>
      <button class="warn full" id="undoBtn">Undo last entry</button>
    </section>

  </div>

  <p class="footer-note">
    Admin only · Updates appear instantly on the big screen
  </p>
</div>

<script type="module">
  import { supabase, EVENT_ID } from "./supabase.js";

  const totalEl = document.getElementById("total");

  async function load() {
    const { data } = await supabase
      .from("events")
      .select("total")
      .eq("id", EVENT_ID)
      .single();

    if (data) {
      totalEl.textContent = data.total.toLocaleString();
    }
  }

  async function add(delta) {
    const { data } = await supabase
      .from("events")
      .select("total")
      .eq("id", EVENT_ID)
      .single();

    if (!data) return;

    const next = Math.max(0, data.total + delta);

    await supabase
      .from("events")
      .update({
        total: next,
        last_delta: delta
      })
      .eq("id", EVENT_ID);
  }

  async function undo() {
    const { data } = await supabase
      .from("events")
      .select("total, last_delta")
      .eq("id", EVENT_ID)
      .single();

    if (!data || !data.last_delta) {
      alert("Nothing to undo.");
      return;
    }

    if (!confirm(`Undo last entry (${data.last_delta})?`)) return;

    const next = Math.max(0, data.total - data.last_delta);

    await supabase
      .from("events")
      .update({
        total: next,
        last_delta: 0
      })
      .eq("id", EVENT_ID);
  }

  // Buttons
  document.querySelectorAll("[data-add]").forEach(btn => {
    btn.onclick = () => add(Number(btn.dataset.add));
  });

  document.getElementById("addManual").onclick = () => {
    const input = document.getElementById("manual");
    const val = Number(input.value);
    if (val > 0) {
      add(val);
      input.value = "";
      input.blur();
    }
  };

  document.getElementById("undoBtn").onclick = undo;

  // Realtime updates
  supabase
    .channel("events")
    .on(
      "postgres_changes",
      { event: "UPDATE", schema: "public", table: "events" },
      payload => {
        totalEl.textContent =
          payload.new.total.toLocaleString();
      }
    )
    .subscribe();

  load();
</script>

</body>
</html>
